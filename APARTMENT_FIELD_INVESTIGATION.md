# Investigation: Missing Apartment Number on UPS Labels

## Problem Summary

The lender's apartment number (street2) is not appearing on UPS shipping labels generated by Shippo, even though the lender fills out the apartment field during the booking accept step.

**Example:**
- Expected: `1745 PACIFIC AVE, APT 4`
- Actual: `1745 PACIFIC AVE` (missing apartment)

---

## Data Flow for Lender Address (street2)

### 1. Frontend: Form Input
**File:** `src/components/ProviderAddressForm/ProviderAddressForm.js`

```javascript
<FieldTextInput
  id="streetAddress2"
  name="streetAddress2"
  label="Street (line 2)"
  placeholder="123"
/>
```

The form field is called `streetAddress2` (NOT required, so user can leave blank).

---

### 2. Frontend: TransactionPanel State
**File:** `src/containers/TransactionPage/TransactionPanel/TransactionPanel.js`

When lender clicks Accept, the form values are extracted:

```javascript
const { streetAddress, streetAddress2, city, state, zipCode, phoneNumber } = this.state.addressValues;
```

Then mapped to protectedData:

```javascript
const mergedProtectedData = {
  ...restProtectedData,
  providerStreet: streetAddress,
  providerStreet2: streetAddress2 || '',  // ‚ö†Ô∏è Falls back to empty string
  providerCity: city,
  // ...
};
```

**üîç Debug Log Added:**
```
üîç [APARTMENT DEBUG] Frontend streetAddress2: { value, type, hasValue, isEmpty }
üîç [APARTMENT DEBUG] Merged protectedData providerStreet2: { value, included }
```

---

### 3. Frontend: Duck (Redux Action)
**File:** `src/containers/TransactionPage/TransactionPage.duck.js`

The protectedData is built from params:

```javascript
const providerPD = {
  providerStreet2: params.providerStreet2,  // From form
  // ...
};

// Clean out empty strings
const cleanedProviderPD = Object.fromEntries(
  Object.entries(providerPD).filter(([, v]) => v != null && String(v).trim() !== '')
);
```

**‚ö†Ô∏è CRITICAL:** If `providerStreet2` is an empty string `''`, it will be **filtered out** by the cleaning function.

**üîç Debug Logs Added:**
```
üîç [APARTMENT DEBUG] Duck providerPD.providerStreet2: { value, hasValue, type }
üîç [APARTMENT DEBUG] Duck cleanedProviderPD.providerStreet2: { value, included }
```

---

### 4. Backend: Transition Endpoint
**File:** `server/api/transition-privileged.js`

The backend receives `bodyParams.params.protectedData` and merges it:

```javascript
const incomingProtectedData = bodyParams?.params?.protectedData || {};

// Remove blank updates from incoming data
const cleaned = Object.fromEntries(
  Object.entries(incomingProtectedData).filter(([, v]) => v != null && String(v).trim() !== '')
);

// Merge transaction PD with cleaned incoming PD
const mergedProtectedData = { ...txProtectedData, ...cleaned };
```

**‚ö†Ô∏è CRITICAL:** If `providerStreet2` was already filtered out on the frontend, it won't be here either.

**üîç Debug Logs Added:**
```
üîç [APARTMENT DEBUG] Incoming providerStreet2: { hasField, value, type, isEmpty }
üîç [APARTMENT DEBUG] After cleaning: { hasProviderStreet2, providerStreet2Value }
‚úÖ [MERGE FIX] Final merged provider fields: { providerStreet2, ... }
```

---

### 5. Backend: Shippo Label Creation
**File:** `server/api/transition-privileged.js` (createShippingLabels function)

The address is built from protectedData:

```javascript
const rawProviderAddress = {
  street1: protectedData.providerStreet,
  street2: protectedData.providerStreet2,  // ‚ö†Ô∏è May be undefined
  city: protectedData.providerCity,
  // ...
};

const addressFrom = buildShippoAddress(rawProviderAddress, { suppressEmail: false });
```

**üîç Debug Logs Added:**
```
üîç [APARTMENT DEBUG] Raw protectedData fields: { providerStreet, providerStreet2, hasStreet2, street2Value }
üîç [APARTMENT DEBUG] Built addressFrom: { hasStreet2, street2Value, fullAddress }
```

---

### 6. Shippo API Call

The payload sent to Shippo:

```javascript
const outboundPayload = {
  address_from: addressFrom,  // Should contain street2
  address_to: addressTo,
  parcels: [parcel],
  async: false
};
```

**üîç Debug Log (Already Exists):**
```
üì¶ [SHIPPO] Outbound shipment payload: <full JSON>
```

---

## Root Cause Analysis

### Hypothesis 1: Empty String Filtering (MOST LIKELY)

If the lender **did not fill out** the apartment field:
1. Form value: `streetAddress2 = undefined` or `''`
2. Frontend maps to: `providerStreet2: streetAddress2 || ''` ‚Üí `''`
3. Cleaning filters out empty strings ‚Üí `providerStreet2` is **removed**
4. Backend receives no `providerStreet2` key
5. Shippo gets `street2: undefined` ‚Üí Not printed on label

**‚úÖ This is expected behavior if field is left blank.**

---

### Hypothesis 2: Value Present But Lost

If the lender **DID fill out** the apartment field (e.g., "Apt 4"):
1. Form value: `streetAddress2 = "Apt 4"`
2. Should pass through cleaning: `"Apt 4".trim() !== ''` ‚Üí ‚úÖ Kept
3. Should reach backend with value
4. Should be sent to Shippo

**‚ùå If this is happening, there's a bug.**

---

## Testing Instructions

### Step 1: Reproduce in Browser

1. **Start the app** and navigate to a transaction where you're the lender
2. **Open browser console** (F12 ‚Üí Console tab)
3. **Fill out the lender address form:**
   - Street: `1745 PACIFIC AVE`
   - **Street (line 2): `Apt 4`** ‚Üê Important!
   - City: `SAN FRANCISCO`
   - State: `CA`
   - Zip: `94109`
   - Phone: `(415) 555-1234`
4. **Click "Accept Booking"**

---

### Step 2: Check Browser Console Logs

Look for these debug logs (in order):

```
üîç [APARTMENT DEBUG] Frontend streetAddress2: { value: "Apt 4", type: "string", hasValue: true, isEmpty: false }
üîç [APARTMENT DEBUG] Merged protectedData providerStreet2: { value: "Apt 4", included: true }
üîç [APARTMENT DEBUG] Duck providerPD.providerStreet2: { value: "Apt 4", hasValue: true, type: "string" }
üîç [APARTMENT DEBUG] Duck cleanedProviderPD.providerStreet2: { value: "Apt 4", included: true }
```

**‚ùå If any of these show empty values or `included: false`, the bug is on the frontend.**

---

### Step 3: Check Server Logs

SSH into your server or check logs (Render.com dashboard, etc.) and look for:

```
üîç [APARTMENT DEBUG] Incoming providerStreet2: { hasField: true, value: "Apt 4", type: "string", isEmpty: false }
üîç [APARTMENT DEBUG] After cleaning: { hasProviderStreet2: true, providerStreet2Value: "Apt 4" }
‚úÖ [MERGE FIX] Final merged provider fields: { providerStreet2: "Apt 4", ... }
üîç [APARTMENT DEBUG] Raw protectedData fields: { providerStreet2: "Apt 4", hasStreet2: true, ... }
üîç [APARTMENT DEBUG] Built addressFrom: { hasStreet2: true, street2Value: "Apt 4", ... }
üì¶ [SHIPPO] Outbound shipment payload: {
  "address_from": {
    "street1": "1745 PACIFIC AVE",
    "street2": "Apt 4",  ‚Üê Should be here
    ...
  }
}
```

**‚ùå If `street2` is missing from the Shippo payload, the bug is in address building or Shippo API.**

---

### Step 4: Check Shippo Dashboard

1. Go to https://goshippo.com/
2. Log in to your account
3. Navigate to **Shipments** ‚Üí Find the recent shipment
4. Click on the shipment ‚Üí Check **Address From**
5. Verify if `street2` was included in the request

---

## Potential Fixes

### Fix 1: If Empty String is the Issue

**Problem:** Lender is not filling out the apartment field, so it's being filtered out (expected).

**Solution:** Make the field required OR accept that some addresses don't have apartments.

---

### Fix 2: If buildShippoAddress is Stripping It

**File:** `server/shippo/buildAddress.js`

Check the logic:

```javascript
// Add optional street2 if provided
if (rawAddress.street2) {
  address.street2 = rawAddress.street2;
}
```

**Issue:** If `rawAddress.street2` is an empty string `''`, this condition is falsy, so it won't be added.

**Fix:** Change to:

```javascript
if (rawAddress.street2 && rawAddress.street2.trim() !== '') {
  address.street2 = rawAddress.street2;
}
```

---

### Fix 3: If Frontend Cleaning is Too Aggressive

**File:** `src/containers/TransactionPage/TransactionPage.duck.js`

Current cleaning:

```javascript
const cleanedProviderPD = Object.fromEntries(
  Object.entries(providerPD).filter(([, v]) => v != null && String(v).trim() !== '')
);
```

**Issue:** Removes empty strings (probably intentional).

**Potential Fix:** Explicitly preserve `providerStreet2` even if empty:

```javascript
const cleanedProviderPD = Object.fromEntries(
  Object.entries(providerPD).filter(([k, v]) => 
    k === 'providerStreet2' || (v != null && String(v).trim() !== '')
  )
);
```

**‚ö†Ô∏è Warning:** This would send `providerStreet2: ''` to the backend, which may not be desired.

---

## Next Steps

1. **Deploy** the debug logging changes
2. **Run a live test** with a real booking
3. **Collect logs** from browser and server
4. **Identify** where `providerStreet2` is lost (if at all)
5. **Apply fix** based on findings
6. **Verify** on Shippo label PDF

---

## Files Modified (Debug Logging Added)

- ‚úÖ `server/api/transition-privileged.js` (5 debug logs)
- ‚úÖ `src/containers/TransactionPage/TransactionPanel/TransactionPanel.js` (2 debug logs)
- ‚úÖ `src/containers/TransactionPage/TransactionPage.duck.js` (2 debug logs)

---

## Contact

If you find that `providerStreet2` is present all the way through to the Shippo payload but still not showing on the label, contact **Shippo Support** with:
- Shipment ID
- Transaction ID
- Screenshot of payload showing `street2`
- PDF of label showing missing apartment

---

**End of Investigation Guide**

