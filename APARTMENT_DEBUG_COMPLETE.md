# Apartment Number Investigation - Complete âœ…

## ğŸ¯ Objective
Investigate why the lender's apartment number (street2) is missing on UPS shipping labels generated by Shippo.

---

## âœ… What We Did

### 1. Code Analysis
We traced the complete data flow from frontend form â†’ backend API â†’ Shippo API:

```
Form Input (streetAddress2)
   â†“
Frontend State (addressValues.streetAddress2)
   â†“
Redux Action (params.providerStreet2)
   â†“
Frontend Cleaning (filter empty strings)
   â†“
API Request (bodyParams.params.protectedData.providerStreet2)
   â†“
Backend Merge (mergedProtectedData.providerStreet2)
   â†“
Shippo Address Builder (rawProviderAddress.street2)
   â†“
Shippo API Payload (address_from.street2)
   â†“
UPS Label Generation
```

### 2. Unit Testing
Created and ran `test-apartment-field.js` to verify `buildShippoAddress` handles street2 correctly.

**Result:** âœ… ALL TESTS PASSED
- âœ… Includes street2 when value is present (`"Apt 4"`)
- âœ… Omits street2 when undefined
- âœ… Omits street2 when empty string
- âœ… Preserves whitespace-only values (edge case)

### 3. Debug Logging
Added **9 debug checkpoints** throughout the entire flow:

#### Frontend (Browser Console)
1. Form values extraction
2. Merged protectedData
3. Redux action before cleaning
4. Redux action after cleaning

#### Backend (Server Logs)
5. Incoming protectedData from frontend
6. After cleaning/filtering
7. Final merged protectedData
8. Raw protectedData before address building
9. Built Shippo address object

**Plus:** Existing log of full Shippo API payload (JSON)

---

## ğŸ” Key Findings

### Finding #1: Code is Correct
The code **properly handles street2** at every step:
- âœ… Form captures it
- âœ… Frontend passes it
- âœ… Backend merges it
- âœ… Shippo receives it

### Finding #2: Filtering Behavior
Empty strings are intentionally filtered out in two places:
1. **Frontend:** `filter(([, v]) => v != null && String(v).trim() !== '')`
2. **Backend:** Same filter

**Impact:** If `streetAddress2` is blank, `providerStreet2` is **not sent** to Shippo.

### Finding #3: Optional Field
The "Street (line 2)" field is **not required** in the form.

**Current Behavior:**
- âœ… If lender fills it out â†’ Sent to Shippo
- âœ… If lender leaves it blank â†’ Not sent to Shippo

---

## ğŸ¯ Most Likely Scenario

**The lender did not fill out the apartment field.**

### Why?
1. Field is optional (no asterisk *)
2. Label says "Street (line 2)" - not obvious it's for apartment
3. Placeholder text is just "123" - not descriptive

### Evidence Needed
Run a live test where the lender **explicitly fills out** the apartment field and check if it appears on the label.

---

## ğŸ“Š Testing Plan

### Step 1: Deploy Debug Logging
```bash
git add .
git commit -m "Add comprehensive debug logging for apartment field"
git push origin test
```

### Step 2: Run Live Test
1. Create a booking
2. **As lender, accept and fill out:**
   - Street: `1745 PACIFIC AVE`
   - **Street (line 2): `Apt 4`** â† Actually fill this out!
   - City: `SAN FRANCISCO`
   - State: `CA`
   - Zip: `94109`

### Step 3: Collect Logs

#### Browser Console (F12)
Look for:
```
ğŸ” [APARTMENT DEBUG] Frontend streetAddress2: { value: "Apt 4", hasValue: true }
ğŸ” [APARTMENT DEBUG] Duck cleanedProviderPD.providerStreet2: { included: true }
```

#### Server Logs
Look for:
```
ğŸ” [APARTMENT DEBUG] Incoming providerStreet2: { value: "Apt 4", isEmpty: false }
ğŸ” [APARTMENT DEBUG] After cleaning: { hasProviderStreet2: true }
ğŸ“¦ [SHIPPO] Outbound shipment payload: {
  "address_from": { "street2": "Apt 4" }
}
```

### Step 4: Check Label
Download the UPS label PDF and verify:
```
MONICA D
1745 PACIFIC AVE APT 4
SAN FRANCISCO CA 94109
```

---

## ğŸ› Troubleshooting Matrix

| Symptom | Location | Likely Cause | Next Action |
|---------|----------|--------------|-------------|
| No value in browser logs | Frontend | Form not capturing | Check form input binding |
| Value in browser, not in API call | Frontend | Cleaning filter | Check cleaning logic |
| Value in API call, not in backend | Network | Data loss in transit | Check network logs |
| Value in backend, not in Shippo payload | Backend | Address builder | Check buildShippoAddress |
| Value in Shippo payload, not on label | Shippo/UPS | Carrier issue | Contact Shippo Support |

---

## ğŸ’¡ Potential Improvements (Optional)

### Option 1: Make Field More Obvious
Change label from "Street (line 2)" to:
```
"Apartment, Suite, or Unit #"
```

### Option 2: Add Helper Text
```
<FieldTextInput
  id="streetAddress2"
  name="streetAddress2"
  label="Apartment / Suite / Unit # (optional)"
  placeholder="Apt 4, Suite 200, Unit B, etc."
/>
```

### Option 3: Add Validation Prompt
After user clicks "Accept", show:
```
"Do you have an apartment, suite, or unit number? 
 [ Yes - add it ] [ No - continue ]"
```

### Option 4: Pre-fill from Profile
If lender has an apartment in their user profile, pre-fill the field (but allow editing).

---

## ğŸ“¦ Deliverables

### Code Changes
- âœ… `server/api/transition-privileged.js` - 5 debug logs added
- âœ… `src/containers/TransactionPage/TransactionPanel/TransactionPanel.js` - 2 debug logs
- âœ… `src/containers/TransactionPage/TransactionPage.duck.js` - 2 debug logs

### Test Files
- âœ… `test-apartment-field.js` - Unit test (passes âœ…)

### Documentation
- âœ… `APARTMENT_FIELD_INVESTIGATION.md` - Detailed technical guide
- âœ… `APARTMENT_INVESTIGATION_SUMMARY.md` - Executive summary
- âœ… `APARTMENT_QUICK_REF.md` - Quick reference card
- âœ… `APARTMENT_DEBUG_COMPLETE.md` - This file

---

## ğŸš€ Next Steps

1. **Deploy** the debug logging to staging/production
2. **Run** a live test with apartment field filled out
3. **Review** logs to confirm data flow
4. **Check** generated label PDF

If apartment appears on label â†’ âœ… Problem solved (user wasn't filling it out)

If apartment still missing â†’ ğŸ“ Contact Shippo Support with logs and payload

---

## ğŸ“ Support Resources

### Internal Testing
```bash
# Run unit test locally
node test-apartment-field.js
```

### Documentation
- Quick start: `APARTMENT_QUICK_REF.md`
- Deep dive: `APARTMENT_FIELD_INVESTIGATION.md`
- Summary: `APARTMENT_INVESTIGATION_SUMMARY.md`

### Shippo Support
- Dashboard: https://goshippo.com/
- Support: support@goshippo.com
- Docs: https://docs.goshippo.com/

---

## âœ… Status

- âœ… Code analysis complete
- âœ… Unit tests passing
- âœ… Debug logging in place
- âœ… Documentation complete
- â³ **Ready for live testing**

---

**Last Updated:** 2025-11-05  
**Status:** Investigation complete, awaiting live test results

